<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Broadsign Dynamic Metadata Example</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      h1 {
        color: #333;
      }
      h2 {
        color: #666;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }
      input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }
      .log-entry {
        margin-bottom: 5px;
        padding: 5px;
        border-left: 3px solid #007bff;
        background: white;
      }
      .log-entry.received {
        border-left-color: #28a745;
      }
      .log-entry.error {
        border-left-color: #dc3545;
      }
      .method {
        background: #e9ecef;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
      }
    </style>
  </head>
  <body>
    <h1>üéØ Broadsign Dynamic Metadata Example</h1>
    <p>
      This example shows how each client can provide their own unique Broadsign
      metadata when connecting to the Echo server.
    </p>

    <!-- Method 1: Token Metadata -->
    <div class="container">
      <h2>Method 1: Generate Token with Metadata (Recommended)</h2>
      <div class="method">
        <p>
          <strong>How it works:</strong> Client requests a unique token with
          their Broadsign metadata embedded.
        </p>
        <p>
          <strong>Best for:</strong> Each client having a unique identity and
          metadata.
        </p>
      </div>

      <div class="form-group">
        <label>Client ID</label>
        <input
          type="text"
          id="clientId1"
          value="screen-lobby-01"
          placeholder="screen-lobby-01"
        />
      </div>
      <div class="form-group">
        <label>Frame ID</label>
        <input
          type="text"
          id="frameId1"
          value="frame-lobby-01"
          placeholder="frame-lobby-01"
        />
      </div>
      <div class="form-group">
        <label>Ad Copy ID</label>
        <input
          type="text"
          id="adCopyId1"
          value="winter-campaign-2025"
          placeholder="ad-copy-123"
        />
      </div>
      <div class="form-group">
        <label>Player ID</label>
        <input
          type="text"
          id="playerId1"
          value="player-bsn-001"
          placeholder="player-001"
        />
      </div>
      <div class="form-group">
        <label>Expected Slot Duration (ms)</label>
        <input
          type="number"
          id="slotDuration1"
          value="45000"
          placeholder="30000"
        />
      </div>

      <button onclick="connectMethod1()">1. Generate Token & Connect</button>
      <button onclick="disconnectMethod1()">Disconnect</button>
      <button onclick="checkHealth()">Check Health</button>

      <div id="status1"></div>
      <div id="log1" class="log"></div>
    </div>

    <!-- Method 2: Query Parameters -->
    <div class="container">
      <h2>Method 2: Use Query Parameters</h2>
      <div class="method">
        <p>
          <strong>How it works:</strong> Use a shared token but provide unique
          Broadsign values in URL parameters.
        </p>
        <p>
          <strong>Best for:</strong> Multiple clients sharing the same token but
          with different metadata.
        </p>
      </div>

      <div class="form-group">
        <label>Shared Token (use the permanent 'screen' token)</label>
        <input
          type="text"
          id="sharedToken"
          value="eyJjbGllbnRJZCI6InNjcmVlbiIsInJvb20iOiJyYWRpbyIsImV4cGlyZXNBdCI6NDkxNDEyMTU2NjQ2NCwibWV0YWRhdGEiOnsidmFsaWRpdHkiOiJObyBleHBpcmF0aW9uIn0sImlzc3VlZEF0IjoxNzYwNTIxNTY2NDY0fQ.1tMYGVIeJl5zPxOclrPWHieEognJGWDaq4-vzjziNi0"
        />
      </div>
      <div class="form-group">
        <label>Frame ID (this client)</label>
        <input
          type="text"
          id="frameId2"
          value="frame-entrance-01"
          placeholder="frame-entrance-01"
        />
      </div>
      <div class="form-group">
        <label>Ad Copy ID</label>
        <input
          type="text"
          id="adCopyId2"
          value="spring-sale-2025"
          placeholder="ad-copy-456"
        />
      </div>
      <div class="form-group">
        <label>Player ID</label>
        <input
          type="text"
          id="playerId2"
          value="player-bsn-002"
          placeholder="player-002"
        />
      </div>
      <div class="form-group">
        <label>Expected Slot Duration (ms)</label>
        <input
          type="number"
          id="slotDuration2"
          value="30000"
          placeholder="30000"
        />
      </div>

      <button onclick="connectMethod2()">2. Connect with Query Params</button>
      <button onclick="disconnectMethod2()">Disconnect</button>
      <button onclick="checkHealth()">Check Health</button>

      <div id="status2"></div>
      <div id="log2" class="log"></div>
    </div>

    <!-- Health Check Results -->
    <div class="container">
      <h2>Health Check Results</h2>
      <p>View all connected clients with their Broadsign metadata:</p>
      <button onclick="checkHealth()">Refresh Health</button>
      <div id="healthResults" class="log"></div>
    </div>

    <script>
      let ws1 = null;
      let ws2 = null;
      const SERVER_URL = "http://localhost:8080";
      const WS_URL = "ws://localhost:8080";

      function log(containerId, message, type = "info") {
        const logContainer = document.getElementById(containerId);
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function showStatus(statusId, message, type = "info") {
        const statusDiv = document.getElementById(statusId);
        statusDiv.className = `status ${type}`;
        statusDiv.textContent = message;
        setTimeout(() => (statusDiv.textContent = ""), 5000);
      }

      async function connectMethod1() {
        try {
          log("log1", "üîÑ Requesting token with custom metadata...");

          // Get values from form
          const clientId = document.getElementById("clientId1").value;
          const frameId = document.getElementById("frameId1").value;
          const adCopyId = document.getElementById("adCopyId1").value;
          const playerId = document.getElementById("playerId1").value;
          const slotDuration = document.getElementById("slotDuration1").value;

          // Request token with metadata
          const response = await fetch(`${SERVER_URL}/auth/token`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              clientId: clientId,
              room: "radio",
              metadata: {
                frameId: frameId,
                adCopyId: adCopyId,
                playerId: playerId,
                expectedSlotDurationMs: slotDuration,
              },
            }),
          });

          if (!response.ok) {
            throw new Error(`Token request failed: ${response.status}`);
          }

          const { token } = await response.json();
          log("log1", `‚úÖ Token received: ${token.substring(0, 30)}...`);

          // Connect WebSocket
          ws1 = new WebSocket(`${WS_URL}?token=${token}`);

          ws1.onopen = () => {
            log("log1", "‚úÖ WebSocket connected!", "received");
            showStatus("status1", "Connected successfully!", "success");
          };

          ws1.onmessage = (event) => {
            const data = JSON.parse(event.data);
            log("log1", `üì© Received: ${JSON.stringify(data)}`, "received");
          };

          ws1.onerror = (error) => {
            log("log1", `‚ùå Error: ${error}`, "error");
            showStatus("status1", "Connection error!", "error");
          };

          ws1.onclose = () => {
            log("log1", "üîå Disconnected");
            showStatus("status1", "Disconnected", "info");
          };
        } catch (error) {
          log("log1", `‚ùå Error: ${error.message}`, "error");
          showStatus("status1", error.message, "error");
        }
      }

      function disconnectMethod1() {
        if (ws1) {
          ws1.close();
          ws1 = null;
          log("log1", "üîå Disconnecting...");
        }
      }

      function connectMethod2() {
        try {
          const token = document.getElementById("sharedToken").value;
          const frameId = document.getElementById("frameId2").value;
          const adCopyId = document.getElementById("adCopyId2").value;
          const playerId = document.getElementById("playerId2").value;
          const slotDuration = document.getElementById("slotDuration2").value;

          log("log2", "üîÑ Connecting with query parameters...");

          // Build URL with query parameters
          const url = `${WS_URL}?token=${encodeURIComponent(
            token
          )}&frameId=${encodeURIComponent(
            frameId
          )}&adCopyId=${encodeURIComponent(
            adCopyId
          )}&playerId=${encodeURIComponent(
            playerId
          )}&expectedSlotDurationMs=${encodeURIComponent(slotDuration)}`;

          ws2 = new WebSocket(url);

          ws2.onopen = () => {
            log("log2", "‚úÖ WebSocket connected!", "received");
            showStatus("status2", "Connected successfully!", "success");
          };

          ws2.onmessage = (event) => {
            const data = JSON.parse(event.data);
            log("log2", `üì© Received: ${JSON.stringify(data)}`, "received");
          };

          ws2.onerror = (error) => {
            log("log2", `‚ùå Error: ${error}`, "error");
            showStatus("status2", "Connection error!", "error");
          };

          ws2.onclose = () => {
            log("log2", "üîå Disconnected");
            showStatus("status2", "Disconnected", "info");
          };
        } catch (error) {
          log("log2", `‚ùå Error: ${error.message}`, "error");
          showStatus("status2", error.message, "error");
        }
      }

      function disconnectMethod2() {
        if (ws2) {
          ws2.close();
          ws2 = null;
          log("log2", "üîå Disconnecting...");
        }
      }

      async function checkHealth() {
        try {
          const response = await fetch(`${SERVER_URL}/health?detailed=true`);
          const health = await response.json();

          const resultsDiv = document.getElementById("healthResults");
          resultsDiv.innerHTML = "";

          if (health.rooms && health.rooms.radio) {
            const radio = health.rooms.radio;
            const entry = document.createElement("div");
            entry.className = "log-entry";
            entry.innerHTML = `
                        <strong>üìä Radio Room Statistics:</strong><br>
                        <strong>Total Clients:</strong> ${
                          radio.clients.total
                        }<br>
                        <strong>Content History:</strong> ${
                          radio.contentHistorySize
                        } items<br>
                        <br>
                        <strong>Connected Clients:</strong><br>
                        ${radio.clients.details
                          .map(
                            (client) => `
                            <div style="margin-left: 20px; margin-top: 10px; padding: 10px; background: #f8f9fa; border-left: 3px solid #007bff;">
                                <strong>ID:</strong> ${client.id}<br>
                                <strong>Connected:</strong> ${
                                  client.connected
                                }<br>
                                <strong>Address:</strong> ${
                                  client.clientAddress
                                }<br>
                                ${
                                  client.broadsign
                                    ? `
                                    <strong style="color: #28a745;">üéØ Broadsign Metadata:</strong><br>
                                    <div style="margin-left: 20px;">
                                        <strong>Frame ID:</strong> ${
                                          client.broadsign.frameId || "N/A"
                                        }<br>
                                        <strong>Ad Copy ID:</strong> ${
                                          client.broadsign.adCopyId || "N/A"
                                        }<br>
                                        <strong>Player ID:</strong> ${
                                          client.broadsign.playerId || "N/A"
                                        }<br>
                                        <strong>Slot Duration:</strong> ${
                                          client.broadsign
                                            .expectedSlotDurationMs || "N/A"
                                        } ms
                                    </div>
                                `
                                    : "<em>No Broadsign metadata</em>"
                                }
                            </div>
                        `
                          )
                          .join("")}
                    `;
            resultsDiv.appendChild(entry);
          } else {
            const entry = document.createElement("div");
            entry.className = "log-entry";
            entry.textContent = "No clients connected";
            resultsDiv.appendChild(entry);
          }
        } catch (error) {
          const entry = document.createElement("div");
          entry.className = "log-entry error";
          entry.textContent = `Error: ${error.message}`;
          document.getElementById("healthResults").appendChild(entry);
        }
      }

      // Auto-check health on load
      window.onload = () => {
        log("log1", "Method 1: Ready to connect with unique token");
        log("log2", "Method 2: Ready to connect with query parameters");
      };
    </script>
  </body>
</html>
